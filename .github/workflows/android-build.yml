name: ğŸ‡¬ğŸ‡µ Build Clavier CrÃ©ole GuadeloupÃ©en

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    name: ğŸ”¨ Build Android APK
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ˜ Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper
        
    - name: ğŸ“± Grant Execute Permission for Gradlew
      run: chmod +x android_keyboard/gradlew
      
    - name: ğŸ” Verify Project Structure
      run: |
        echo "ğŸ“‚ Project structure verification:"
        ls -la android_keyboard/
        echo "ğŸ“± Gradle wrapper check:"
        ls -la android_keyboard/gradlew*
        
    - name: ğŸ” Lint Check
      working-directory: android_keyboard
      run: ./gradlew lintDebug
        
    - name: ğŸ§ª Run Unit Tests
      working-directory: android_keyboard
      run: ./gradlew testDebugUnitTest
        
    - name: ğŸ”¨ Build Debug APK
      working-directory: android_keyboard
      run: ./gradlew assembleDebug
        
    - name: ğŸ“¦ Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: Potomitan-Kreyol-Keyboard-Debug
        path: android_keyboard/app/build/outputs/apk/debug/*.apk
        retention-days: 7
        
    - name: ğŸ”¨ Build Release APK (if main branch)
      if: github.ref == 'refs/heads/main'
      working-directory: android_keyboard
      run: ./gradlew assembleRelease
        
    - name: ğŸ“¦ Upload Release APK
      if: github.ref == 'refs/heads/main'
      uses: actions/upload-artifact@v4
      with:
        name: Potomitan-Kreyol-Keyboard-Release
        path: android_keyboard/app/build/outputs/apk/release/*.apk
        retention-days: 30

  code-quality:
    name: ğŸ” Code Quality Check
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ“± Grant Execute Permission for Gradlew
      run: chmod +x android_keyboard/gradlew
      
    - name: ğŸ” Kotlin Lint
      working-directory: android_keyboard
      run: ./gradlew ktlintCheck || true
        
    - name: ğŸ“Š Generate Code Coverage
      working-directory: android_keyboard
      run: ./gradlew jacocoTestReport || true
        
    - name: ğŸ“ˆ Upload Coverage Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-reports
        path: android_keyboard/app/build/reports/
        retention-days: 7

  dictionary-validation:
    name: ğŸ‡¬ğŸ‡µ Validate CrÃ©ole Dictionary
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: ğŸ“š Install Python Dependencies
      run: |
        pip install json5 pytest
        
    - name: âœ… Validate Dictionary JSON
      run: |
        python -c "
        import json
        import sys
        
        try:
            # Validation du dictionnaire crÃ©ole
            with open('clavier_creole/assets/creole_dict.json', 'r', encoding='utf-8') as f:
                dict_data = json.load(f)
            
            print(f'âœ… Dictionnaire valide: {len(dict_data)} mots crÃ©oles')
            
            # VÃ©rification de la structure
            if isinstance(dict_data, list) and len(dict_data) > 0:
                if isinstance(dict_data[0], list) and len(dict_data[0]) == 2:
                    print('âœ… Structure [mot, frÃ©quence] respectÃ©e')
                else:
                    print('âŒ Structure incorrecte')
                    sys.exit(1)
            else:
                print('âŒ Format de dictionnaire invalide')
                sys.exit(1)
                
        except Exception as e:
            print(f'âŒ Erreur validation dictionnaire: {e}')
            sys.exit(1)
        "
        
    - name: ğŸ“Š Dictionary Statistics
      run: |
        python -c "
        import json
        
        with open('clavier_creole/assets/creole_dict.json', 'r', encoding='utf-8') as f:
            dict_data = json.load(f)
        
        total_words = len(dict_data)
        frequencies = [item[1] for item in dict_data if len(item) >= 2]
        
        print(f'ğŸ“Š Statistiques du dictionnaire crÃ©ole:')
        print(f'   â€¢ Total mots: {total_words}')
        print(f'   â€¢ FrÃ©quence max: {max(frequencies) if frequencies else 0}')
        print(f'   â€¢ FrÃ©quence min: {min(frequencies) if frequencies else 0}')
        print(f'   â€¢ Mots avec accents: {sum(1 for item in dict_data if any(c in item[0] for c in \"Ã Ã¨Ã²Ã©Ã¹Ã®Ã§\"))}')
        "

  security-scan:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ” Run Trivy Vulnerability Scanner
      uses: aquasecurity/trivy-action@master
      with:
        scan-type: 'fs'
        scan-ref: '.'
        format: 'sarif'
        output: 'trivy-results.sarif'
        
    - name: ğŸ“¤ Upload Trivy Results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-results.sarif'

  notification:
    name: ğŸ“¢ Build Notification
    runs-on: ubuntu-latest
    needs: [build, code-quality, dictionary-validation]
    if: always()
    
    steps:
    - name: ğŸ‰ Success Notification
      if: needs.build.result == 'success'
      run: |
        echo "ğŸ‰ âœ… CLAVIER CRÃ‰OLE GUADELOUPÃ‰EN - BUILD RÃ‰USSI !"
        echo "ğŸ‡¬ğŸ‡µ Le clavier Potomitanâ„¢ est prÃªt Ã  Ãªtre dÃ©ployÃ©"
        echo "ğŸ“± APK gÃ©nÃ©rÃ© et disponible dans les artifacts"
        
    - name: âŒ Failure Notification
      if: needs.build.result == 'failure'
      run: |
        echo "âŒ ğŸš¨ CLAVIER CRÃ‰OLE - BUILD Ã‰CHOUÃ‰"
        echo "ğŸ”§ VÃ©rifiez les logs pour diagnostiquer le problÃ¨me"
        echo "ğŸ“ Consultez les rapports de qualitÃ© de code"