name: ğŸ‡¸ğŸ‡· Build Potomitan Kreyol Keyboard - Detailed Steps

permissions:
  contents: write
  packages: write

on:
  push:
    branches: [ main ]
    paths:
      - 'android_keyboard/**'
      - '.github/workflows/**'
      - 'Dictionnaries/**'
    tags:
      - 'v*'
  pull_request:
    branches: [ main ]
    paths:
      - 'android_keyboard/**'
      - 'Dictionnaries/**'
  workflow_dispatch:

jobs:
  # ğŸ“Š Ã‰TAPE 1 : GÃ‰NÃ‰RATION DICTIONNAIRE
  generate-dictionary:
    name: ğŸ”¤ Generate KreyÃ²l Dictionary
    runs-on: ubuntu-latest
    
    env:
      HF_TOKEN: ${{ secrets.HF_TOKEN }}
      
    outputs:
      dict-count: ${{ steps.stats.outputs.dict-count }}
      ngrams-count: ${{ steps.stats.outputs.ngrams-count }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: ğŸ“¦ Generate Fresh KreyÃ²l Dictionary
      run: |
        echo "ğŸ”„ Generating fresh KreyÃ²l dictionary from Hugging Face..."
        echo "ğŸ”‘ Token configurÃ©: $(if [ -n "$HF_TOKEN" ]; then echo "âœ… Oui"; else echo "âŒ Non"; fi)"
        
        cd Dictionnaires
        echo "ğŸ“ Contenu avant gÃ©nÃ©ration:"
        ls -la
        
        python -m pip install --upgrade pip
        pip install datasets huggingface_hub
        
        echo "ğŸš€ Lancement du script Python..."
        python KreyolComplet.py
        
        echo "ğŸ“ Contenu aprÃ¨s gÃ©nÃ©ration:"
        ls -la
        
        echo "ğŸ” VÃ©rification fichiers JSON gÃ©nÃ©rÃ©s dans clavier_creole/assets/:"
        ls -la ../clavier_creole/assets/creole_*.json || echo "âŒ Aucun fichier JSON trouvÃ© dans clavier_creole/assets/"

    - name: ğŸ“Š Verify Generated Assets
      run: |
        echo "ï¿½ VÃ©rification des fichiers gÃ©nÃ©rÃ©s..."
        
        # Le script Python gÃ©nÃ¨re directement dans clavier_creole/assets/
        if [ ! -f "clavier_creole/assets/creole_dict.json" ]; then
          echo "âŒ ERREUR: creole_dict.json manquant dans clavier_creole/assets/!"
          echo "ğŸ“ Contenu du dossier clavier_creole/assets/:"
          ls -la clavier_creole/assets/ || echo "Dossier inexistant"
          echo "ğŸ“ Contenu du dossier Dictionnaires:"
          ls -la Dictionnaires/
          exit 1
        fi
        
        if [ ! -f "clavier_creole/assets/creole_ngrams.json" ]; then
          echo "âŒ ERREUR: creole_ngrams.json manquant dans clavier_creole/assets/!"
          echo "ğŸ“ Contenu du dossier clavier_creole/assets/:"
          ls -la clavier_creole/assets/ || echo "Dossier inexistant"
          exit 1
        fi
        
        echo "âœ… Fichiers gÃ©nÃ©rÃ©s avec succÃ¨s dans clavier_creole/assets/!"
        echo "ğŸ“Š Tailles des fichiers:"
        ls -lh clavier_creole/assets/creole_*.json

    - name: ğŸ“ˆ Dictionary Statistics
      id: stats
      run: |
        # Statistiques directement depuis clavier_creole/assets/ oÃ¹ le script gÃ©nÃ¨re
        DICT_COUNT=$(jq 'length' clavier_creole/assets/creole_dict.json)
        NGRAMS_COUNT=$(jq 'length' clavier_creole/assets/creole_ngrams.json)
        echo "ğŸ“Š Dictionary: $DICT_COUNT words, $NGRAMS_COUNT N-grams"
        echo "dict-count=$DICT_COUNT" >> $GITHUB_OUTPUT
        echo "ngrams-count=$NGRAMS_COUNT" >> $GITHUB_OUTPUT

    - name: ğŸ¯ Copy Dictionary to Android Assets Directory
      run: |
        echo "ğŸ“ PrÃ©paration des assets Android..."
        mkdir -p android_keyboard/app/src/main/assets/
        
        # Copier directement vers le rÃ©pertoire Android
        cp clavier_creole/assets/creole_dict.json android_keyboard/app/src/main/assets/
        cp clavier_creole/assets/creole_ngrams.json android_keyboard/app/src/main/assets/
        
        echo "âœ… Dictionnaires copiÃ©s vers android_keyboard/app/src/main/assets/"
        echo "ğŸ“Š VÃ©rification:"
        ls -la android_keyboard/app/src/main/assets/creole_*.json

    - name: ğŸ¯ Dictionary Assets Ready
      run: |
        echo "âœ… Assets de dictionnaire prÃªts pour les builds Android"
        echo "ï¿½ Statistiques finales:"
        DICT_COUNT=$(jq 'length' android_keyboard/app/src/main/assets/creole_dict.json)
        NGRAMS_COUNT=$(jq 'length' android_keyboard/app/src/main/assets/creole_ngrams.json)
        echo "   - Mots: $DICT_COUNT"
        echo "   - N-grams: $NGRAMS_COUNT"
        echo "ï¿½ Fichiers disponibles pour tous les jobs de build"

  # ğŸ”§ Ã‰TAPE 2A : BUILD DEBUG APK
  build-debug-apk:
    name: ğŸ”§ Build Debug APK
    runs-on: ubuntu-latest
    needs: generate-dictionary
    
    env:
      KEYSTORE_FILE: potomitan-keystore.jks
      STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: âœ… Verify Dictionary Assets Present
      run: |
        echo "ğŸ” VÃ©rification des assets de dictionnaire..."
        if [ -f "android_keyboard/app/src/main/assets/creole_dict.json" ]; then
          echo "âœ… creole_dict.json prÃ©sent"
        else
          echo "âŒ creole_dict.json manquant"
          exit 1
        fi
        
        if [ -f "android_keyboard/app/src/main/assets/creole_ngrams.json" ]; then
          echo "âœ… creole_ngrams.json prÃ©sent"
        else
          echo "âŒ creole_ngrams.json manquant"
          exit 1
        fi
        
        echo "ğŸ“Š Tailles des fichiers:"
        ls -lh android_keyboard/app/src/main/assets/creole_*.json

    - name: ğŸ§¹ Clean Project
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle clean --no-daemon --scan

    - name: ğŸ”¨ Build Debug APK
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle assembleDebug --no-daemon --scan

    - name: ğŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: kreyol-keyboard-debug-apk
        path: android_keyboard/app/build/outputs/apk/debug/*.apk
        retention-days: 7

  # ğŸ“¦ Ã‰TAPE 2B : BUILD DEBUG AAB  
  build-debug-aab:
    name: ğŸ“¦ Build Debug AAB
    runs-on: ubuntu-latest
    needs: generate-dictionary
    
    env:
      KEYSTORE_FILE: potomitan-keystore.jks
      STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: âœ… Verify Dictionary Assets Present
      run: |
        echo "ğŸ” VÃ©rification des assets de dictionnaire..."
        ls -lh android_keyboard/app/src/main/assets/creole_*.json || echo "âŒ Fichiers dictionnaire manquants"

    - name: ğŸ“¦ Build Debug AAB
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle bundleDebug --no-daemon --scan

    - name: ğŸ“¤ Upload Debug AAB
      uses: actions/upload-artifact@v4
      with:
        name: kreyol-keyboard-debug-aab
        path: android_keyboard/app/build/outputs/bundle/debug/*.aab
        retention-days: 7

  # ğŸš€ Ã‰TAPE 3A : BUILD RELEASE APK
  build-release-apk:
    name: ğŸš€ Build Release APK
    runs-on: ubuntu-latest
    needs: generate-dictionary
    
    env:
      KEYSTORE_FILE: potomitan-keystore.jks
      STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: âœ… Verify Dictionary Assets Present
      run: |
        echo "ğŸ” VÃ©rification des assets de dictionnaire..."
        ls -lh android_keyboard/app/src/main/assets/creole_*.json || echo "âŒ Fichiers dictionnaire manquants"

    - name: ğŸ” Generate Debug Keystore (CI Only)
      run: |
        cd android_keyboard
        echo "ğŸ”‘ Generating debug keystore for CI build..."
        keytool -genkey -v -keystore app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"

    - name: ğŸ§¹ Clean Project  
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle clean --no-daemon --scan

    - name: ğŸš€ Build Release APK
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle assembleRelease --no-daemon --scan

    - name: ğŸ“¤ Upload Release APK
      uses: actions/upload-artifact@v4
      with:
        name: kreyol-keyboard-release-apk
        path: android_keyboard/app/build/outputs/apk/release/*.apk
        retention-days: 30

  # ğŸ¯ Ã‰TAPE 3B : BUILD RELEASE AAB
  build-release-aab:
    name: ğŸ¯ Build Release AAB  
    runs-on: ubuntu-latest
    needs: generate-dictionary
    
    env:
      KEYSTORE_FILE: potomitan-keystore.jks
      STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
      KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
      KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.7
        cache-read-only: false

    - name: âœ… Verify Dictionary Assets Present
      run: |
        echo "ğŸ” VÃ©rification des assets de dictionnaire..."
        ls -lh android_keyboard/app/src/main/assets/creole_*.json || echo "âŒ Fichiers dictionnaire manquants"

    - name: ğŸ” Generate Debug Keystore (CI Only)
      run: |
        cd android_keyboard
        echo "ğŸ”‘ Generating debug keystore for CI build..."
        keytool -genkey -v -keystore app/debug.keystore -alias androiddebugkey -keyalg RSA -keysize 2048 -validity 10000 -storepass android -keypass android -dname "CN=Android Debug,O=Android,C=US"

    - name: ğŸ¯ Build Release AAB
      env:
        GRADLE_OPTS: "-Dorg.gradle.buildscan.termsOfServiceUrl=https://gradle.com/terms-of-service -Dorg.gradle.buildscan.termsOfServiceAgree=yes"
      run: cd android_keyboard && gradle bundleRelease --no-daemon --scan

    - name: ğŸ“¤ Upload Release AAB
      uses: actions/upload-artifact@v4
      with:
        name: kreyol-keyboard-release-aab  
        path: android_keyboard/app/build/outputs/bundle/release/*.aab
        retention-days: 30

  # ğŸ“± Ã‰TAPE 4 : VALIDATION & TESTS
  validate-builds:
    name: ğŸ” Validate Builds
    runs-on: ubuntu-latest
    needs: [build-debug-apk, build-debug-aab, build-release-apk, build-release-aab]
    
    steps:
    - name: ğŸ“¥ Download All Artifacts
      uses: actions/download-artifact@v4
      with:
        path: ./all-builds

    - name: ğŸ“Š Build Summary
      run: |
        echo "ğŸ¯ BUILD VALIDATION SUMMARY"
        echo "=========================="
        
        find ./all-builds -name "*.apk" -o -name "*.aab" | while read file; do
          echo "ğŸ“± $(basename "$file"): $(stat -f%z "$file" 2>/dev/null || stat -c%s "$file") bytes"
        done

    - name: âœ… Mark Builds Valid
      run: echo "âœ… All builds completed successfully!"

  # ğŸ‰ Ã‰TAPE 5 : CRÃ‰ATION RELEASE (si tag)
  create-release:
    name: ğŸ‰ Create Release
    runs-on: ubuntu-latest
    needs: [generate-dictionary, validate-builds]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: ğŸ“¥ Download Release Artifacts
      uses: actions/download-artifact@v4
      with:
        pattern: kreyol-keyboard-release-*
        path: ./release-artifacts

    - name: ğŸ“ Prepare Release Assets with Custom Names
      run: |
        echo "ğŸ“ PrÃ©paration des assets pour release..."
        mkdir -p ./final-release-assets
        
        echo "ğŸ” Contenu des artifacts tÃ©lÃ©chargÃ©s:"
        find ./release-artifacts -type f -name "*.apk" -o -name "*.aab" | head -10
        
        # Renommer APK avec version du tag
        if [ -f "./release-artifacts/kreyol-keyboard-release-apk/app-release.apk" ]; then
          cp "./release-artifacts/kreyol-keyboard-release-apk/app-release.apk" "./final-release-assets/KreyolKeyboard-${{ github.ref_name }}.apk"
          echo "âœ… APK prÃ©parÃ©: KreyolKeyboard-${{ github.ref_name }}.apk"
        else
          echo "âŒ APK release non trouvÃ© dans artifacts"
          ls -la ./release-artifacts/kreyol-keyboard-release-apk/ || echo "Dossier APK inexistant"
        fi
        
        # Renommer AAB avec version du tag  
        if [ -f "./release-artifacts/kreyol-keyboard-release-aab/app-release.aab" ]; then
          cp "./release-artifacts/kreyol-keyboard-release-aab/app-release.aab" "./final-release-assets/KreyolKeyboard-${{ github.ref_name }}.aab"
          echo "âœ… AAB prÃ©parÃ©: KreyolKeyboard-${{ github.ref_name }}.aab"
        else
          echo "âŒ AAB release non trouvÃ© dans artifacts"
          ls -la ./release-artifacts/kreyol-keyboard-release-aab/ || echo "Dossier AAB inexistant"
        fi
        
        echo "ğŸ“Š Assets finaux prÃ©parÃ©s:"
        ls -la ./final-release-assets/

    - name: ğŸ‰ Create GitHub Release with Assets
      id: create_release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        name: ğŸ‡¸ğŸ‡· KreyÃ²l Keyboard ${{ github.ref_name }}
        body: |
          ğŸ¯ **Clavier KreyÃ²l Potomitan Release ${{ github.ref_name }}**
          
          ğŸ”§ **AMÃ‰LIORATIONS TECHNIQUES**
          - âœ… Build ScanÂ® integration avec monitoring avancÃ©
          - âœ… Pipeline subdivisionnÃ© en 6 jobs parallÃ¨les  
          - âœ… Fix memory leaks Samsung A21s (serviceScope)
          - âœ… Optimisations pour processeurs Exynos 850
          - âœ… Detection low-end devices automatique
          
          ğŸ“± **FICHIERS ANDROID DISPONIBLES**
          - ğŸŸ¢ APK Release pour installation directe
          - ğŸŸ¡ AAB Bundle pour Google Play Store
          - ğŸ“Š Build Scan Reports pour analyse dÃ©taillÃ©e
          
          ğŸ”¤ **DICTIONNAIRE KREYÃ’L ENRICHI** 
          - âœ… ${{ needs.generate-dictionary.outputs.dict-count }} mots crÃ©oles
          - ğŸ§  ${{ needs.generate-dictionary.outputs.ngrams-count }} N-grams prÃ©dictifs
          - ğŸ“¡ Synchronisation automatique Hugging Face
          - ğŸ”„ Pipeline de gÃ©nÃ©ration optimisÃ©
          
          ğŸ‡¸ğŸ‡· **KreyÃ²l Gwadloup ka viv!** ğŸ‡¸ğŸ‡·
          
          ---
          ğŸ”— **Build Details**: Consulter les Build Scan Reports pour analyse complÃ¨te des performances
        draft: false
        prerelease: false
        make_latest: true
        files: |
          ./final-release-assets/KreyolKeyboard-${{ github.ref_name }}.apk
          ./final-release-assets/KreyolKeyboard-${{ github.ref_name }}.aab