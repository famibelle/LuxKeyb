name: Build and Release Signed APK

on:
  push:
    branches: [ main ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ”§ Setup Gradle
      uses: gradle/actions/setup-gradle@v3
      with:
        gradle-version: 8.4
        
    - name: Decode Keystore
      env:
        ENCODED_STRING: ${{ secrets.KEYSTORE_BASE64 }}
      run: |
        mkdir -p android_keyboard/app/keystore
        echo "$ENCODED_STRING" | base64 --decode > android_keyboard/app/keystore/my-release-key.jks
        echo "Keystore created at: android_keyboard/app/keystore/my-release-key.jks"
        ls -la android_keyboard/app/keystore/
        
    - name: Clean project
      run: |
        cd android_keyboard && gradle clean --no-daemon
        
    - name: Build Release APK (Signed)
      env:
        STORE_FILE: keystore/my-release-key.jks
        STORE_PASSWORD: ${{ secrets.STORE_PASSWORD }}
        KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
        KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
      run: |
        cd android_keyboard
        echo "Using keystore: $STORE_FILE"
        echo "Key alias: $KEY_ALIAS"
        echo "Working directory: $(pwd)"
        echo "App directory contents:"
        ls -la app/
        echo "Keystore directory contents:"
        ls -la app/keystore/ || echo "Keystore directory not found"
        gradle assembleRelease --no-daemon
        
    - name: ğŸ“¦ Find APK files
      id: apk_files
      run: |
        cd android_keyboard
        RELEASE_APK=$(find app/build/outputs/apk/release -name "*.apk" | head -1)
        
        echo "Found Release APK: $RELEASE_APK"
        echo "release_apk=$RELEASE_APK" >> $GITHUB_OUTPUT
        
    - name: ğŸ“Š APK Info
      run: |
        cd android_keyboard
        echo "ğŸ” Signed Release APK:"
        ls -lh "${{ steps.apk_files.outputs.release_apk }}"
        
    - name: Upload APK as artifact
      uses: actions/upload-artifact@v4
      with:
        name: signed-apk
        path: android_keyboard/${{ steps.apk_files.outputs.release_apk }}
        
    - name: ğŸš€ Create Release
      if: startsWith(github.ref, 'refs/tags/v')
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ github.ref_name }}
        name: ğŸ‡¬ğŸ‡µ KlaviÃ© KreyÃ²l Karukera ${{ github.ref_name }} (Signed)
        body: |
          ## ï¿½ğŸ‡µ KlaviÃ© KreyÃ²l Karukera â€¢ Potomitanâ„¢ (SIGNED RELEASE)
          
          **Nouveau clavier crÃ©ole pour la Guadeloupe - Version signÃ©e !**
          
          ### âœ¨ FonctionnalitÃ©s :
          - ğŸŒˆ Design moderne caribÃ©en (bleu caraÃ¯be, jaune soleil, vert canne)
          - ğŸ“ Suggestions intelligentes basÃ©es sur un vrai dictionnaire crÃ©ole
          - ğŸ”¤ Accents crÃ©oles (Ã , Ã¨, Ã², etc.) avec long-press
          - ğŸ“š Dictionnaire de 5910 mots crÃ©oles authentiques
          - ğŸ¯ Sources littÃ©raires intÃ©grÃ©es (Telchid, Rupaire, Fontes, etc.)
          - ğŸ”’ **APK signÃ©e pour installation sÃ©curisÃ©e**
          
          ### ğŸ“± Installation :
          1. TÃ©lÃ©chargez le fichier **APK signÃ©e** ci-dessous
          2. Autorisez l'installation d'applications inconnues dans les paramÃ¨tres Android
          3. Installez l'APK en touchant le fichier tÃ©lÃ©chargÃ©
          4. Activez le clavier dans **ParamÃ¨tres â†’ SystÃ¨me â†’ Langues et saisie â†’ Claviers virtuels**
          5. SÃ©lectionnez **Potomitan Kreyol Keyboard**
          
          ### ï¿½ SÃ©curitÃ© :
          - APK signÃ©e avec certificat de production
          - Code source ouvert et auditable
          - Pas de trackers ou analytics
          - Permissions minimales requises
          
          ---
          **AlÃ© douvan Ã©pi klaviÃ© kreyÃ²l-la !** âŒ¨ï¸âœ¨
        files: |
          android_keyboard/${{ steps.apk_files.outputs.release_apk }}
        draft: false
        prerelease: false
        generate_release_notes: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}