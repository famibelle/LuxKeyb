name: ï¿½ğŸ‡µ Build Potomitan Kreyol Keyboard APK

on:
  push:
    branches: [ main ]
    paths:
      - 'android_keyboard/**'
      - '.github/workflows/**'
      - 'Dictionnaries/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'android_keyboard/**'
      - 'Dictionnaries/**'
  workflow_dispatch:  # Allow manual trigger

jobs:
  validate-dictionaries:
    name: ğŸ“š Validate CrÃ©ole Dictionaries
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'
        
    - name: âœ… Validate Dictionary JSON
      run: |
        python -c "
        import json
        import sys
        
        try:
            # Validation du dictionnaire crÃ©ole
            with open('clavier_creole/assets/creole_dict.json', 'r', encoding='utf-8') as f:
                dict_data = json.load(f)
            
            print(f'âœ… Dictionnaire valide: {len(dict_data)} mots crÃ©oles')
            
            # VÃ©rification de la structure
            if isinstance(dict_data, list) and len(dict_data) > 0:
                if isinstance(dict_data[0], list) and len(dict_data[0]) == 2:
                    print('âœ… Structure [mot, frÃ©quence] respectÃ©e')
                else:
                    print('âŒ Structure incorrecte')
                    sys.exit(1)
            else:
                print('âŒ Format de dictionnaire invalide')
                sys.exit(1)
                
        except Exception as e:
            print(f'âŒ Erreur validation dictionnaire: {e}')
            sys.exit(1)
        "
        
    - name: âœ… Validate N-grams JSON
      run: |
        python -c "
        import json
        import sys
        
        try:
            # Validation des N-grams crÃ©oles
            with open('android_keyboard/app/src/main/assets/creole_ngrams.json', 'r', encoding='utf-8') as f:
                ngram_data = json.load(f)
            
            predictions = ngram_data.get('predictions', {})
            print(f'âœ… N-grams valides: {len(predictions)} entrÃ©es de prÃ©diction')
            
            # VÃ©rifier la structure
            if 'version' in ngram_data and 'branding' in ngram_data:
                print(f'âœ… Version: {ngram_data[\"version\"]}, Branding: {ngram_data[\"branding\"]}')
            else:
                print('âŒ MÃ©tadonnÃ©es manquantes')
                sys.exit(1)
                
        except Exception as e:
            print(f'âŒ Erreur validation N-grams: {e}')
            sys.exit(1)
        "

  build:
    name: ğŸ“± Build Samsung-Compatible APK
    runs-on: ubuntu-latest
    needs: validate-dictionaries
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: â˜• Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        
    - name: ğŸ˜ Setup Gradle
      uses: gradle/gradle-build-action@v2
      with:
        gradle-version: wrapper
        
    - name: ï¿½ Verify Project Structure
      run: |
        echo "ğŸ“‚ Project structure verification:"
        ls -la android_keyboard/
        echo "ğŸ“± Gradle wrapper check:"
        ls -la android_keyboard/gradlew*
        echo "ğŸ“š Assets check:"
        ls -la android_keyboard/app/src/main/assets/
        
    - name: ï¿½ğŸ“„ Make Gradlew Executable
      run: chmod +x android_keyboard/gradlew
      
    - name: ğŸ§¹ Clean Project
      working-directory: android_keyboard
      run: ./gradlew clean
        
    - name: ğŸ”¨ Build Debug APK (Samsung Compatible)
      working-directory: android_keyboard
      run: ./gradlew assembleDebug
        
    - name: ğŸ”¨ Build Release APK (Samsung Compatible)
      working-directory: android_keyboard
      run: ./gradlew assembleRelease
        
    - name: ğŸ“ List Built APKs
      run: |
        echo "ğŸ¯ APK Files Built:"
        find android_keyboard/app/build/outputs/apk -name "*.apk" -exec ls -la {} \;
        
    - name: ğŸ“¤ Upload Debug APK
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ“± Potomitan-Kreyol-Keyboard-DEBUG-Samsung
        path: android_keyboard/app/build/outputs/apk/debug/*.apk
        retention-days: 30
        
    - name: ğŸ“¤ Upload Release APK  
      uses: actions/upload-artifact@v4
      with:
        name: ğŸ“± Potomitan-Kreyol-Keyboard-RELEASE-Samsung
        path: android_keyboard/app/build/outputs/apk/release/*.apk
        retention-days: 90
        
    - name: ğŸ“Š APK Info
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo ""
        echo "ğŸ“± Debug APK (Easy Installation):"
        ls -la android_keyboard/app/build/outputs/apk/debug/*.apk
        echo ""
        echo "ğŸ“± Release APK (Production):"
        ls -la android_keyboard/app/build/outputs/apk/release/*.apk
        echo ""
        echo "ğŸ”— Download APKs from GitHub Actions Artifacts section"
        echo "ğŸ’¡ For Samsung tablets: Try DEBUG version first (easier to install)"
        
  # Job pour crÃ©er une release automatique sur les tags
  release:
    name: ğŸš€ Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download Debug APK
      uses: actions/download-artifact@v4
      with:
        name: ğŸ“± Potomitan-Kreyol-Keyboard-DEBUG-Samsung
        path: ./apk-debug/
        
    - name: ğŸ“¥ Download Release APK
      uses: actions/download-artifact@v4
      with:
        name: ğŸ“± Potomitan-Kreyol-Keyboard-RELEASE-Samsung
        path: ./apk-release/
        
    - name: ğŸš€ Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./apk-debug/*.apk
          ./apk-release/*.apk
        name: Potomitan Kreyol Keyboard ${{ github.ref_name }}
        body: |
          ## ğŸ‡¬ğŸ‡µ Potomitan Kreyol Keyboard ${{ github.ref_name }}
          
          ### ğŸŒŸ NouveautÃ©s
          - âœ… **Layout AZERTY CrÃ©ole** optimisÃ© : `azertyuiopÃ Ã©` / `qsdfghjklmÃ²` / `wxcvbnÃ¨`
          - âœ… **Accents crÃ©oles intÃ©grÃ©s** directement dans le clavier
          - âœ… **Dictionnaire enrichi** : 1867 mots crÃ©oles avec frÃ©quences
          - âœ… **N-grams intelligents** : prÃ©dictions contextuelles en temps rÃ©el
          - âœ… **Samsung Ultra-Compatible** APKs
          
          ### ğŸ¯ FonctionnalitÃ©s Principales
          - **Suggestions intelligentes** : Combinaison dictionnaire + N-grams
          - **PrÃ©dictions contextuelles** : "yo" â†’ "ka", "tÃ©", "di"
          - **AccÃ¨s direct aux accents** : Ã , Ã¨, Ã², Ã© visibles sur le clavier
          - **Mode numÃ©rique** avec basculement fluide
          - **Design GuadeloupÃ©en** avec couleurs tropicales
          
          ### ï¿½ Installation (Samsung OptimisÃ©)
          
          **ğŸ¯ Pour Samsung Tablets (RecommandÃ©)**:
          1. TÃ©lÃ©charger **DEBUG APK** (plus facile Ã  installer)
          2. Activer "Sources inconnues" dans ParamÃ¨tres â†’ SÃ©curitÃ©
          3. Installer l'APK via l'app "Mes fichiers"
          4. Activer le clavier dans ParamÃ¨tres â†’ Langues et saisie
          
          **ğŸ“± Variantes APK**:
          - **DEBUG**: `Potomitan_Kreyol_Keyboard_v*_debug_*.apk` (RecommandÃ© Samsung)
          - **RELEASE**: `Potomitan_Kreyol_Keyboard_v*_release_*.apk` (Production)
          
          ### ï¿½ DÃ©tails Techniques
          - **ApplicationId**: `com.potomitan.kreyolkeyboard`
          - **Target SDK**: 33 (OptimisÃ© Samsung)  
          - **Architectures**: arm64-v8a, armeabi-v7a
          - **Dictionnaire**: 1867 mots crÃ©oles
          - **N-grams**: 15601+ entrÃ©es de prÃ©diction
          - **CompatibilitÃ© Samsung**: Ultra-optimisÃ©
          
          ### ğŸï¸ Ã€ propos
          **Potomitanâ„¢** - Clavier intelligent pour la saisie en **KreyÃ²l GuadeloupÃ©en**
          
          DÃ©veloppÃ© avec â¤ï¸ pour prÃ©server et promouvoir la langue crÃ©ole guadeloupÃ©enne.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
